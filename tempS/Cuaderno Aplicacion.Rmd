---
title: ""
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---
```{r,message=FALSE,echo = FALSE,warning=FALSE}
load('data_c.RData')
```

En la aplicación con datos se busca encontrar la relación entre la precipitación diaria (en mm) y el caudal diario del río (en $m^3/s$) de dos ríos donde un río desemboca en el otro en una región del departamento del Cauca en Colombia.La precipitación se midió en la estación meteorológica San Juan con una altitud de 2400 metros. El primer caudal del río se midió en la estación hidrológica ''El Trébol'' del río Bedón con una altitud de 1720 metros y el segundo caudal se midió en el río de la Plata en la estación hidrológica de ''Villalosada'' con una altitud de 1300 metros. Las estaciones están ubicadas cerca del ecuador de la Tierra en una zona geográfica muy seca. Esta última característica permite el control de factores hidrológicos/meteorológicos, los cuales pueden distorsionar el tipo de relación dinámica explicada por el modelo MTAR.

El período de tiempo que se considero es del 1 de enero de 2006 al 14 de abril de 2009 (1200 puntos de tiempo) que tiene 57 puntos de tiempo con datos faltantes en la serie de precipitaciones, 214 en la serie del caudal del río Bedon y 213 en la serie del cauce del río de la Plata. Estos datos fueron proporcionados por el IDEAM (disponibles en la librería R para los modelos TAR y MTAR).

```{r,message=FALSE}
# install.packages("devtools")
# devtools::install_github("adrincont/BMTAR",force = TRUE)
library(BMTAR)
library(zoo)
library(patchwork)
imput_y = function(y){
  ts_prob = data.frame(time = 1:length(y),dat = y)
  ts_prob_2 = ts_prob[!is.na(ts_prob$dat),]
  ks_imput = ksmooth(x = ts_prob_2$time,y = ts_prob_2$dat,'normal'
                     ,bandwidth= 10,x.points = 1:length(y))
  ts_prob$dat[is.na(ts_prob$dat)] = ks_imput$y[is.na(ts_prob$dat)]
  return(ts_prob$dat)
}
```

```{r,message=FALSE,fig.height = 3,fig.width=10,message=FALSE}
# [Lectura de Datos]
data("hydrodata")
Yt = hydrodata[,3:4]
Pt = hydrodata$Rainfall
data_miss = list(Yt = as.matrix(log(sqrt(Yt[-1,]))),
                 Zt = as.matrix(sqrt(Pt[-nrow(hydrodata)])))
## Graficas de las series ..................................................####
datos = tsregime(Yt = data_miss$Yt,Zt = data_miss$Zt)
autoplot(datos,1) + autoplot(datos,2)
```

Para la aplicación de la metodología para estimación de modelos MTAR con datos faltantes se recurre a la Liberia de R ‘’MTAR’’ (librería basada en el mismo artículo y que implementa toda la metodología de estimación). Como primer paso y como se propone en el articulo se consideran las series transformadas $Y_t = (\ln{\sqrt(Y_{1t}}),\ln(\sqrt{Y_{2t}}))$ y $Z_t = \sqrt{P_{t-1}}$ (precipitaciones y el caudal bivariado de los ríos Bedón y La Plata el día t). En la metodología de estimación para estos modelos, el primer paso corresponde a la imputación inicial de datos faltantes que en este caso se realiza por medio de un promedio móvil sobre cada uno de los componentes.

```{r,message=FALSE,fig.height = 3,fig.width=10}
Y_temp = datos$Yt
Y_temp[,1] = imput_y(Y_temp[,1])
Y_temp[,2] = imput_y(Y_temp[,2])
Z_temp = datos$Zt
Z_temp[,1] = imput_y(Z_temp[,1])
datos_temp = tsregime(Yt = Y_temp,Zt = Z_temp)
autoplot(datos_temp,1) + autoplot(datos_temp,2)
```

Una vez completada la serie, el siguiente paso corresponde a la estimación del número de regímenes mediante el método de selección de modelos de ''Carlin and Chib'' y el uso del criterio ''NAIC'', seguido de la estimación de ordenes para el modelo por medio de la metodología de ''Kuo and Mallick'' (ambas metodologías explicadas en la primera parte de estos informes). Para ello, se usan las funciones ''mtarnumreg()'' y ''mtarstr()'' que implementan dichas metodologías usando prioris no informativas (el usuario podría dar prioris informativas si es el caso).

```{r,fig.height = 3,fig.width=10,message=FALSE}
# initial = mtarinipars(tsregime_obj = datos_temp,list_model = list(l0_max = 3),method = 'KUO')
# estim_nr = mtarnumreg(ini_obj = initial,iterprev = 2000,niter_m = 3000,burn_m = 1000,
#                      list_m = TRUE,ordersprev = list(maxpj = 5,maxqj = 0,maxdj = 5))
autoplot(estim_nr,1)$m2 + autoplot(estim_nr,1)$m3
```

```{r}
mtarNAIC(estim_nr$list_m$m2$par);mtarNAIC(estim_nr$list_m$m3$par)
```

Teniendo en cuenta criterios como el comportamiento de las cadenas en los muestreadores en donde se observa mayor estabilidad para el caso de $l=2$, los resultados en las pruebas de diagnóstico con 2 y 3 regímenes y los valores resultantes del criterio NAIC (donde en las pruebas que se hicieron el menor NAIC siempre resulta ser $l=2$), se seleccionan dos regímenes en el modelo. A continuación, usando como punto de partida inicial de $r = 2.66$, se realiza la estimación de parámetros no estructurales para el modelo MTAR (órdenes para rezagos y variable de umbrales), esto por medio de la función ''mtarstr()'' que implementa la metodología de selección de variables conjuntamente con la estimación de los demás parámetros.

```{r,fig.height = 3,fig.width=10,message=FALSE}
# initial = mtarinipars(tsregime_obj = datos_temp,list_model = list(l0_max = 3),method = 'KUO')
# estim_nr = mtarnumreg(ini_obj = initial,iterprev = 2000,niter_m = 3000,burn_m = 1000,
#                      list_m = TRUE,ordersprev = list(maxpj = 5,maxqj = 0,maxdj = 5))
autoplot(estim_nr,1)$m2 + autoplot(estim_nr,1)$m3
```

Observando en los resultados del procedimiento el comportamiento de las variables gamma (variables indicadoras relacionadas con los ordenes) y sus frecuencias mas comunes, se tienen las estimaciones de ordenes para el modelo con $p_1 = 5,d_1 = 4$ para el primer regimen y $p_1 = 5,d_1 = 5$ para el segundo ademas de una estimación para $r = 2.6$. Luego de encontrar un aproximación a los ordenes de los rezagos (parámetros estructurales) así como del valor del umbral es posible una primera estimación de los datos faltantes (por medio de la metodología del filtro de Kalman y el modelo espacio-estado), esto a partir de la función ``mtarmissing()'' que realiza la estimación de datos faltantes realizando el proceso de muestreo conjunto de parámetros no estructurales y observaciones faltantes. El la gráfica observamos el valor puntual y su respectivo intervalo de credibilidad al 95\% en azul para los valores faltantes.

```{r,fig.height = 3,fig.width=10,warning=FALSE}
# list_model = list(pars = list(l = 2,r = 2.6,orders = list(pj = c(5,5),dj = c(4,5))))
# initial = mtarinipars(tsregime_obj = tsregime(Yt = data_miss$Yt,Zt = data_miss$Zt),list_model = list_model)
# missingest = mtarmissing(ini_obj = initial,chain = TRUE, niter = 5000,burn = 1000)
# data_c = missingest$tsregim
autoplot(missingest,4)[[1]] + autoplot(missingest,4)[[2]]
```

Una vez completados los valores faltantes es necesario realizar nuevamente el procedimiento tanto de estimación de la cantidad de régimenes (que siguiendo el mismo procedimiento de la parte inicial, resulta por criterio NAIC $l=2$ regímenes) como de los parámetros estructurales para seguir reestimando los valores faltantes hasta tener una convergencia. Una vez concluido este proceso y teniendo los valores finales tanto de los faltantes como de los parámetros estructurales se realiza la estimación final de los parámetros no estructurales por medio de la función ``mtarns()'' que implementa los muestreadores de acuerdo a los parámetros a estimar. Para los cuales evaluamos el comportamiento de las cadenas y supuestos sobre los residuos al ajuste final.

Los primeros gráficos nos muestran un buen comportamiento de cadenas sin valores que salten, por su parte los residuos aunque presenten algunas inconsistencias en normalidad podemos ver que no son autocorrelacionados, sin embargo es posible considerar otros ajustes al modelo para garantizar los supuestos.

```{r,fig.height = 3,fig.width=10,warning=FALSE,message=FALSE}
# initial = mtarinipars(tsregime_obj = data_c,list_model = list(pars = list(l = 2,orders = list(pj = c(5,5),dj = c(4,5)))))
# ns2 = mtarns(ini_obj = initial,niter = 15000,chain = TRUE,burn = 5000,r_init = 2.6)
autoplot(ns2,1)
autoplot(ns2,2)$R1+autoplot(ns2,2)$R2
autoplot(ns2,3)$R1$c+autoplot(ns2,3)$R2$c
```
```{r,fig.height = 6,fig.width=10,warning=FALSE,message=FALSE}
autoplot(ns2,3)$R1$phi+autoplot(ns2,3)$R2$phi
autoplot(ns2,3)$R1$delta+autoplot(ns2,3)$R2$delta
```
```{r,fig.height = 4,fig.width=10,warning=FALSE,message=FALSE}
diagnostic_mtar(ns2)[[2]] +  diagnostic_mtar(ns2)[[3]]
diagnostic_mtar(ns2)[[4]] + diagnostic_mtar(ns2)[[5]]
diagnostic_mtar(ns2)[[6]]
```

Finalmente vemos la estimación de los parámetros con valor de umbral estimado 2.54 y en el gráfico el ajuste del modelo a la serie de datos una vez completados los valores faltantes.

```{r,fig.height = 3,fig.width=10,warning=FALSE,message=FALSE}
ns2$regime
autoplot(ns2,5)
```

Con lo anterior ya es posible realizar el pronóstico de la serie, por medio de la función ``mtarforecast()'' considerando $h = 10$ observamos el prónostico 10 pasos adelante tanto de la variable de respuesta como umbral con su respectivo intervalo de credibilidad al 95\% 

```{r,fig.height = 3,fig.width=10}
#pred1 = mtarforecast(ns2,h = 10)
pred1$forecast$estim
```

